#! /bin/bash

bold=$(tput bold)
normal=$(tput sgr0)

boldEcho() {
  echo "${bold}$1${normal}" 
}

gitWithExit() {
  git $@
  if [ "$?" -ne 0 ]; then
    echo
    echo "ERROR: Something went wrong!"
    echo "See the previous output ðŸ‘† for more details."
    echo 
    exit "$?"
  fi
}

if [ -z "$(git status --porcelain)" ]; then 
  echo
  boldEcho "Deploying current branch to staging..."
  echo
  boldEcho "-> Updating local staging branch"
  gitWithExit switch staging
  gitWithExit pull origin
  echo
  boldEcho "-> Merging current branch into staging"
  gitWithExit merge --commit --no-edit -
  echo
  boldEcho "-> Pushing to staging"
  gitWithExit push origin
  echo
  boldEcho "-> Switching back to original branch"
  gitWithExit switch -
  echo
  boldEcho "DONE!"
else 
  boldEcho "You have changes in your working directory."
  boldEcho "Commit or stash them before running this command."
  exit 1
fi
